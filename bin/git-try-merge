#!/bin/bash

# More information:
# http://stackoverflow.com/questions/6335717/can-git-tell-me-if-a-merge-will-conflict-without-actually-merging

SHOW_DIFF=

function error() {
	echo "ERROR: $*" 1>&2
}

function help() {
	echo "$(basename $0) - Git tool to try a merge without commiting data."
	echo "Diego Lago <diego.lago.gonzalez@gmail.com> - github.com/diegolagoglez/git-tools"
	echo "Usage: $(basename $0) [options] <branch>"
	echo "Options:"
	echo "  -d     Show diff after check."
	echo "  -h     Show this help."
	exit 1
}

function branchExists() {
	git rev-parse --verify "$1" >/dev/null 2>&1
}

function tryMerge() {
	git format-patch ..$1 --stdout | git apply --check - 2>/dev/null
	ret=$?
	if [ -n "$SHOW_DIFF" ]; then
		git diff $1
	fi
	exit $ret
}

function main() {
	if [ $# == 0 ]; then
		help
	fi

	while getopts ":hd" opt; do
		case "$opt" in
			h)
				help
			;;
			d)
				SHOW_DIFF=yes
				shift
			;;
			\?)
				error "Invalid option: -$OPTARG"
				exit 2
			;;
		esac
	done

	if [ $# -ne 1 ]; then
		error "Must specify only one branch."
		exit 3
	fi

	if ! branchExists "$1"; then
		error "Branch does not exist: $1"
		exit 4
	fi

	tryMerge "$1"
}

main "$@"
