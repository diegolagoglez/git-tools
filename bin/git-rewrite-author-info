#!/bin/bash

OLD_EMAIL=
CORRECT_NAME=
CORRECT_EMAIL=

function error() {
	echo "ERROR: $1" 1>&2
	exit $2
}

function rewrite_author_info() {
	# Documentation: https://help.github.com/articles/changing-author-info/
	git filter-branch --env-filter '
	 
	OLD_EMAIL="diego.lago.gonzalez@gmail.com"
	CORRECT_NAME="Diego Lago"
	CORRECT_EMAIL="diego.lago@hp.com"
	 
	if [ "$GIT_COMMITTER_EMAIL" = "$OLD_EMAIL" ]
	then
	    export GIT_COMMITTER_NAME="$CORRECT_NAME"
	    export GIT_COMMITTER_EMAIL="$CORRECT_EMAIL"
	fi
	if [ "$GIT_AUTHOR_EMAIL" = "$OLD_EMAIL" ]
	then
	    export GIT_AUTHOR_NAME="$CORRECT_NAME"
	    export GIT_AUTHOR_EMAIL="$CORRECT_EMAIL"
	fi
	' --tag-name-filter cat -- --branches --tags
}

function credits() {
	echo "$(basename $0) - Utility to rewrite history changing the author information."
	echo " *** WARNING: This utility may be dangerous. Use with care. ***"
	echo "GPLv3 2014 - Diego Lago <diego.lago.gonzalez@gmail>"
}

function usage() {
	echo "Usage: $(basename $0) [options]"
	echo "Options:"
	echo " -h    : Show this help."
}

function main() {
	while getopts ":ho:n:e:" opt; do
		case "$opt" in
			"h")
				credits
				usage
			;;
			"o")
				OLD_EMAIL="$OPTARG"
			;;
			"n")
				CORRECT_NAME="$OPTARG"
			;;
			"e")
				CORRECT_EMAIL="$OPTARG"
			;;
			\?)
				error "Invalid option: -$OPTARG" 1
			;;
			\:)
				error "Option -$OPTARG requires an argument." 1
			;;
		esac
	done

	if [ -z "$OLD_EMAIL" ]; then
		error "Must specify an old email (with -o option)."
	fi
	if [ -z "$CORRECT_NAME" ]; then
		error "Must specify a correct name (with -n option)."
	fi
	if [ -z "$CORRECT_EMAIL" ]; then
		error "Must specify a correct email (with -e option)."
	fi
}

main "$@"
